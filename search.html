<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Textured Gradient Background</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet"> <!-- Poppins font -->
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: stretch;
            background: linear-gradient(to top right, #FF2A49, #FFD60E);
            position: relative;
            overflow: hidden;
            font-family: 'Poppins', sans-serif; /* Apply Poppins font */
        }

        /* Dark overlay only for background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.25);
            z-index: 1;
            pointer-events: none;
        }

        .popup-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 2;
        }

        .popup {
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            background: #00000057;
            margin: 10px;
            position: relative;
        }

        /* Left popup takes 40% of the space */
        .popup:first-child {
            flex: 0 0 40%;
            padding: 10px 40px 10px 10px;
        }

        /* Right popup takes 60% of the space */
        .popup:last-child {
            flex: 0 0 58%;
            padding: 40px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
        }

        .grid-item {
            background-color: #f0f0f0;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 100%;
            height: 100%;
        }

        /* Search bar styling */
        .search-bar-container {
            position: absolute;
            right: 6%; /* Align to the right with offset */
            top: 50%;
            transform: translateY(-50%);
            width: 68%; /* 60% of the popup's width */
        }
        .no-underline {
            text-decoration: none;  /* Removes the underline */
        }


        .time-display {
            text-align: left;
            margin-bottom: 5px;
            font-size: 4.5rem;
            color: #fff;
            width: 100%;
            padding: 0;
            box-sizing: border-box;
            background-color: transparent;
        }
        .grid-item img {
            width: 100%;   /* Make the image fill the width of the grid item */
            height: 100%;  /* Make the image fill the height of the grid item */
            object-fit: cover; /* Ensures the image covers the entire space of the grid item without distorting */
            border-radius: 8px; /* Optional: Apply the same border radius to the image */
        }       
        .date-display {
            text-align: left;
            margin-bottom: 5px;
            font-size: 2.3rem;
            color: #fff;
            width: 100%;
            padding: 0;
            box-sizing: border-box;
            background-color: transparent;
        }

        .search-bar {
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 20px 10px;
            font-size: 1rem;
            border: 1px solid #000000e4;
            border-radius: 5px;
            color: #fff;
            outline: none;
            background: #0009
        }

        .clear-btn {
            position: absolute;
            right: 10px;
            top: 45%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #ffffff;
            cursor: pointer;
            display: none;
        }

        .search-bar input:not(:empty) + .clear-btn {
            display: block;
        }

        .search-bar input::placeholder {
            color: #ffffff;
        }

        #historyPopup {
    display: none;
    background-color: rgba(0, 0, 0, 0.7);
    padding: 10px;
    border-radius: 5px;
    color: white;
    margin-top: 10px;
    width: 100%;
    max-height: 300px;
    overflow-y: auto;
}

.history-title {
    font-weight: bold;
    margin-bottom: 10px;
}

.history-item {
    display: flex;
    align-items: center;
    padding: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.history-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.history-icon {
    margin-right: 10px;
    opacity: 0.7;
}

.history-query {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

    </style>
</head>
<body>
    <div class="popup-container">
        <div class="popup">
            <div class="search-bar-container">
                <div class="time-display" id="timeDisplay"></div>
                <div class="date-display" id="dateDisplay"></div>
                <div class="search-bar">
                    <input type="text" placeholder="Search here..." id="searchInput">
                    <button class="clear-btn" id="clearBtn">&times;</button> <!-- X icon -->
                </div>
                <div id="platformPopup" style="display:none; background-color: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px; color: white; text-align: center; margin-top: 10px; width: 100%"></div>
                <div id="historyPopup" style="display:none; background-color: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px; color: white; text-align: left; margin-top: 10px; width: 100%;"></div>
                <div id="importantDatesPopup" style="display:none; background-color: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px; color: white; text-align: center; margin-top: 10px; width: 100%"></div>
            </div>
        </div>
        <div class="popup">
            <!-- 4x4 Grid for the right popup -->
            <a href="https://x.com/home" class="grid-item no-underline" style="background: #0009 ; color: #fff; font-size: 40px">Twitter</a>
            <a href="https://www.roblox.com/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">Roblox</a>
            <a href="https://www.youtube.com/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">YouTube</a>
            <a href="https://bsky.app/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">Bluesky</a>
            <a href="https://www.threads.net/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">Threads</a>
            <a href="https://www.instagram.com/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">Instagram</a>
            <a href="https://music.youtube.com/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">YT Music</a>
            <a href="https://chatgpt.com/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">ChatGPT</a>
            <a href="https://gemini.google.com/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">Gemini</a>
            <a href="https://claude.ai/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">Claude</a>
            <a href="https://www.perplexity.ai/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">Perplexity</a>
            <a href="https://docs.google.com/spreadsheets/u/0/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">GSheets</a>
            <a href="https://docs.google.com/forms/u/0/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">GForms</a>
            <a href="https://drive.google.com/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">GDrive</a>
            <a href="https://mail.google.com/mail/u/0/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">Gmail</a>
            <a href="https://mail.proton.me/" class="grid-item no-underline" style="background: #0009; color: #fff; font-size: 40px">Proton</a>
        </div>
        
    </div>

    <script>
// Local Storage Keys
const LOCAL_STORAGE_IMPORTANT_DATES = 'importantDates';
const LOCAL_STORAGE_TIME_FORMAT = 'timeFormat';
const LOCAL_STORAGE_SHOW_YEAR = 'showYearPreference';
const LOCAL_STORAGE_WEBSITE_HISTORY = 'websiteSearchHistory';
const LOCAL_STORAGE_PHRASE_HISTORY = 'phraseSearchHistory';
const LOCAL_STORAGE_HISTORY_TRACKING = 'historyTrackingEnabled';
const LOCAL_STORAGE_GRID_USAGE = 'gridItemUsage';



document.addEventListener('click', function(e) {
    if (e.target.closest('.history-item')) {
        const query = e.target.closest('.history-item').getAttribute('data-query');
        document.getElementById('searchInput').value = query;
        document.getElementById('historyPopup').style.display = 'none';
        document.getElementById('clearBtn').style.display = 'block';
    }
});

// Function to add a search to history
function addSearchToHistory(query, isWebsite = false) {
    // Check if history tracking is enabled
    const historyTrackingEnabled = localStorage.getItem(LOCAL_STORAGE_HISTORY_TRACKING) !== 'disabled';
    
    if (!historyTrackingEnabled) return;
    
    // Rest of the existing implementation remains the same
    let websiteHistory = JSON.parse(localStorage.getItem(LOCAL_STORAGE_WEBSITE_HISTORY) || '[]');
    let phraseHistory = JSON.parse(localStorage.getItem(LOCAL_STORAGE_PHRASE_HISTORY) || '[]');

    const currentTime = Date.now();

    if (isWebsite) {
        websiteHistory = websiteHistory.filter(item => item.query !== query);
        websiteHistory.unshift({ query, time: currentTime });
        websiteHistory = websiteHistory.slice(0, 10);
        
        localStorage.setItem(LOCAL_STORAGE_WEBSITE_HISTORY, JSON.stringify(websiteHistory));
    } else {
        phraseHistory = phraseHistory.filter(item => item.query !== query);
        phraseHistory.unshift({ query, time: currentTime });
        phraseHistory = phraseHistory.slice(0, 10);
        
        localStorage.setItem(LOCAL_STORAGE_PHRASE_HISTORY, JSON.stringify(phraseHistory));
    }
}

// Function to track grid item usage
function trackGridItemUsage(url) {
    let gridUsage = JSON.parse(localStorage.getItem(LOCAL_STORAGE_GRID_USAGE) || '{}');
    
    // Increment usage count for the specific URL
    gridUsage[url] = (gridUsage[url] || 0) + 1;
    
    // Save updated usage statistics
    localStorage.setItem(LOCAL_STORAGE_GRID_USAGE, JSON.stringify(gridUsage));
    
    // Reorder grid items based on usage
    reorderGridItems();
}

// Function to reorder grid items based on usage
function reorderGridItems() {
    const gridContainer = document.querySelector('.popup:last-child');
    const gridItems = Array.from(gridContainer.querySelectorAll('.grid-item'));
    const gridUsage = JSON.parse(localStorage.getItem(LOCAL_STORAGE_GRID_USAGE) || '{}');
    
    // Sort grid items by usage (most used first)
    gridItems.sort((a, b) => {
        const usageA = gridUsage[a.getAttribute('href')] || 0;
        const usageB = gridUsage[b.getAttribute('href')] || 0;
        return usageB - usageA;
    });
    
    // Clear the current grid container
    gridContainer.innerHTML = '';
    
    // Reappend sorted grid items
    gridItems.forEach(item => gridContainer.appendChild(item));
}


// Function to render history popup
function renderHistoryPopup(historyType) {
    const historyPopup = document.getElementById('historyPopup');
    
    // Retrieve histories
    const websiteHistory = JSON.parse(localStorage.getItem(LOCAL_STORAGE_WEBSITE_HISTORY) || '[]');
    const phraseHistory = JSON.parse(localStorage.getItem(LOCAL_STORAGE_PHRASE_HISTORY) || '[]');
    
    // Combine and sort histories
    const combinedHistory = [...websiteHistory, ...phraseHistory]
        .sort((a, b) => b.time - a.time)
        .slice(0, 10);
    
    const websiteHistoryContent = websiteHistory.map(item => 
        `<div class="history-item" data-query="${item.query}">
            <span class="history-icon">üåê</span> 
            <span class="history-query">${item.query}</span>
        </div>`
    ).join('');
    
    const phraseHistoryContent = phraseHistory.map(item => 
        `<div class="history-item" data-query="${item.query}">
            <span class="history-icon">üîç</span> 
            <span class="history-query">${item.query}</span>
        </div>`
    ).join('');
    
    const combinedHistoryContent = combinedHistory.map(item => 
        `<div class="history-item" data-query="${item.query}">
            <span class="history-icon">${item.query.startsWith('http') ? 'üåê' : 'üîç'}</span> 
            <span class="history-query">${item.query}</span>
        </div>`
    ).join('');
    
    let popupContent = '';
    let popupTitle = '';
    
    switch(historyType) {
        case '@history_links':
            popupContent = websiteHistoryContent;
            popupTitle = 'Website Search History';
            break;
        case '@history_phrase':
            popupContent = phraseHistoryContent;
            popupTitle = 'Phrase Search History';
            break;
        default: // '@history'
            popupContent = combinedHistoryContent;
            popupTitle = 'Recent Search History';
    }
    
    if (popupContent) {
        historyPopup.innerHTML = `
            <div class="history-header">
                <div class="history-title">${popupTitle}:</div>
                <button id="exit-history-btn" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.5rem;">‚úñ</button>
            </div>
            ${popupContent}
        `;
        historyPopup.style.display = 'block';
        
        // Add event listener for exit button
        document.getElementById('exit-history-btn').addEventListener('click', () => {
            historyPopup.style.display = 'none';
        });
    } else {
        historyPopup.style.display = 'none';
    }
}

// Function to clear all search history
// Function to clear all search history
function clearSearchHistory() {
    const historyTrackingEnabled = localStorage.getItem(LOCAL_STORAGE_HISTORY_TRACKING) !== 'disabled';
    const platformPopup = document.getElementById('platformPopup');
    const historyPopup = document.getElementById('historyPopup');
    
    // Check if history tracking is disabled
    if (!historyTrackingEnabled) {
        platformPopup.textContent = "No History; Tracking Disabled";
        platformPopup.style.display = 'block';
        
        // Ensure history popup is hidden
        historyPopup.style.display = 'none';
        historyPopup.innerHTML = '';
        
        // Fade out the popup after 5 seconds
        setTimeout(() => {
            platformPopup.style.display = 'none';
        }, 5000);
        
        return;
    }
    
    // Check if there's any history to clear
    const websiteHistory = JSON.parse(localStorage.getItem(LOCAL_STORAGE_WEBSITE_HISTORY) || '[]');
    const phraseHistory = JSON.parse(localStorage.getItem(LOCAL_STORAGE_PHRASE_HISTORY) || '[]');
    
    if (websiteHistory.length === 0 && phraseHistory.length === 0) {
        platformPopup.textContent = "No History";
        platformPopup.style.display = 'block';
        
        // Ensure history popup is hidden
        historyPopup.style.display = 'none';
        historyPopup.innerHTML = '';
        
        // Fade out the popup after 5 seconds
        setTimeout(() => {
            platformPopup.style.display = 'none';
        }, 5000);
        
        return;
    }
    
    // Clear the histories
    localStorage.removeItem(LOCAL_STORAGE_WEBSITE_HISTORY);
    localStorage.removeItem(LOCAL_STORAGE_PHRASE_HISTORY);
    
    // Show "Clearing search history" popup
    platformPopup.textContent = "Clearing search history";
    platformPopup.style.display = 'block';
    
    // Ensure history popup is hidden
    historyPopup.style.display = 'none';
    historyPopup.innerHTML = '';
    
    // Fade out the popup after 5 seconds
    setTimeout(() => {
        platformPopup.style.display = 'none';
    }, 5000);
}


// Function to toggle history tracking
function toggleHistoryTracking(clearHistory = false) {
    const currentSetting = localStorage.getItem(LOCAL_STORAGE_HISTORY_TRACKING);
    const newSetting = currentSetting === 'disabled' ? 'enabled' : 'disabled';
    
    localStorage.setItem(LOCAL_STORAGE_HISTORY_TRACKING, newSetting);
    
    const platformPopup = document.getElementById('platformPopup');
    const historyPopup = document.getElementById('historyPopup');
    
    // If clearing history when disabling tracking
    if (clearHistory) {
        clearSearchHistory();
    }
    
    platformPopup.textContent = `History tracking is now ${newSetting}`;
    platformPopup.style.display = 'block';
    
    // Ensure history popup is hidden
    historyPopup.style.display = 'none';
    historyPopup.innerHTML = '';

    // Add timeout to hide the popup after 5 seconds
    setTimeout(() => {
        platformPopup.style.display = 'none';
    }, 5000);
}

// Load important dates from local storage
let importantDates = JSON.parse(localStorage.getItem(LOCAL_STORAGE_IMPORTANT_DATES) || '[]')
    .map(item => ({
        ...item,
        date: new Date(item.date) // Convert string back to Date object
    }));

    // Load time format from local storage
let timeFormat = localStorage.getItem(LOCAL_STORAGE_TIME_FORMAT) || '12';

// Load year display preference from local storage
let showYear = localStorage.getItem(LOCAL_STORAGE_SHOW_YEAR) === 'true';

// Function to save important dates to local storage
function saveImportantDates() {
    localStorage.setItem(
        LOCAL_STORAGE_IMPORTANT_DATES, 
        JSON.stringify(importantDates.map(event => ({
            ...event,
            date: event.date.toISOString() // Convert Date to ISO string for storage
        })))
    );
}

// Function to save time format to local storage
function saveTimeFormat() {
    localStorage.setItem(LOCAL_STORAGE_TIME_FORMAT, timeFormat);
}

// Function to save year display preference to local storage
function saveYearPreference() {
    localStorage.setItem(LOCAL_STORAGE_SHOW_YEAR, showYear.toString());
}

// Function to validate if input is a valid URL
function isValidURL(url) {
    const pattern = /^(https?:\/\/)?([a-zA-Z0-9_-]+\.)+[a-zA-Z]{2,6}(:\d+)?(\/[^\s]*)?$/;
    return pattern.test(url);
}

document.getElementById('searchInput').addEventListener('input', function() {
    const query = this.value.trim().toLowerCase();
    const platformPopup = document.getElementById('platformPopup');

    // Special command emojis
    const specialCommandEmojis = {
        '@important': 'üìÖ', // Calendar emoji for important dates
        '@24t': 'üï∞Ô∏è',       // Clock emoji for 24-hour time format
        '@12t': '‚è∞',        // Alarm clock for 12-hour time format
        '@toggle_history': 'üîÑ', // Refresh/cycle emoji for toggling history
        '@clear_history': 'üßπ'   // Broom emoji for clearing history
    };

    // Check for special commands first
    for (const [command, emoji] of Object.entries(specialCommandEmojis)) {
        if (query.startsWith(command) && (query.length === command.length || query[command.length] === ' ')) {
            let message = '';
            switch(command) {
                case '@important':
                    message = "Setting important date";
                    break;
                case '@24t':
                    message = "Using Function Convert to 24 Hour Display";
                    break;
                case '@12t':
                    message = "Using Function Convert to 12 Hour Display";
                    break;
                case '@toggle_history':
                    message = "Toggling search history tracking";
                    break;
                case '@clear_history':
                    message = "Clearing search history";
                    break;
            }
            platformPopup.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <span style="margin-right: 10px; font-size: 1.5em;">${emoji}</span>
                    <span>${message}</span>
                </div>
            `;
            platformPopup.style.display = 'block';
            return;
        }
    }

    // Existing search prefix checks
    if (query.startsWith('@y') && (query.length === 2 || query[2] === ' ')) {
        platformPopup.textContent = "Searching with YouTube";
        platformPopup.style.display = 'block';
    } 
    else if (query.startsWith('@w') && (query.length === 2 || query[2] === ' ')) {
        platformPopup.textContent = "Searching with Wikipedia";
        platformPopup.style.display = 'block';
    } 
    else if (query.startsWith('@g') && (query.length === 2 || query[2] === ' ')) {
        platformPopup.textContent = "Searching with Google (This is already the default)";
        platformPopup.style.display = 'block';
    } 
    else if (query.startsWith('@rbx') && (query.length === 4 || query[4] === ' ')) {
        platformPopup.textContent = "Searching with Roblox";
        platformPopup.style.display = 'block';
    } 
    else if (query.startsWith('@p') && (query.length === 2 || query[2] === ' ')) {
        platformPopup.textContent = "Searching with Perplexity";
        platformPopup.style.display = 'block';
    } 
    else if (query.startsWith('@mu') &&  (query.length === 3 || query[3] === ' ')) {
        platformPopup.textContent = "Searching with YouTube Music";
        platformPopup.style.display = 'block';
    } 
    else if (query.startsWith('@year') && (query.length === 5 || query[5] === ' ')) {
        platformPopup.textContent = "Using Display Year Function";
        platformPopup.style.display = 'block';
    } 
    else if (query.startsWith('@help') && (query.length === 5 || query[5] === ' ')) {
        platformPopup.innerHTML = `
            <div style="padding: 10px; border-radius: 8px; background-color: rgba(0, 0, 0, 0.7);">
                <h3 style="margin-bottom: 10px;">Command Help</h3>
                <ul style="list-style: none; padding-left: 0; max-height: 100px; overflow-y: auto;">
                    <li><strong>@p</strong>: Searches with Perplexity</li>
                    <li><strong>@y</strong>: Searches with YouTube</li>
                    <li><strong>@g</strong>: Searches with Google (This is the default search engine)</li>
                    <li><strong>@w</strong>: Searches with Wikipedia</li>
                    <li><strong>@mu</strong>: Searches with YouTube Music</li>
                    <li><strong>@rbx</strong>: Searches Roblox experiences</li>
                    <li><strong>@24t</strong>: Changes time display to 24-hour format</li>
                    <li><strong>@12t</strong>: Changes time display to 12-hour format</li>
                    <li><strong>@year</strong>: Toggles displaying the year</li>
                    <li><strong>@important date name</strong>: Lets you set important dates and know how long until they happen</li>
                    <li><strong>@history</strong>: Allows you to check your most reecent searches</li>
                    <li><strong>@history_links</strong>: Allows you to check your most recent searches by websites</li>
                    <li><strong>@history_phrases</strong>: Allows you to check your most recent searches by phrases</li>
                    <li><strong>@clear_history</strong>: Allows you to clear the history</li>
                    <li><strong>@toggle_history</strong>: Allows you to toggle the tracking feature (adding clear after also clears the history if you're disabling history)</li>
                    <li><strong>@export</strong>: Exports time, year, and date info</li>
                    <li><strong>@import</strong>: Imports time, year, and date info</li>
                </ul>
            </div>
        `;
        platformPopup.style.display = 'block';
    }
    else {
        platformPopup.style.display = 'none';
    }
});


document.getElementById('searchInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        let query = this.value.trim();
        const platformPopup = document.getElementById('platformPopup');
        const importantDatesPopup = document.getElementById('importantDatesPopup');

        // History-related commands
        if (query === '@history' || query === '@history_links' || query === '@history_phrase') {
            renderHistoryPopup(query);
            this.value = '';
            return;
        }

                
        // New commands
        if (query === '@clear_history') {
            clearSearchHistory();
            this.value = '';
            return;
        }
        
        if (query === '@toggle_history') {
            toggleHistoryTracking();
            this.value = '';
            return;
        }

        if (query.toLowerCase() === '@toggle_history clear') {
            toggleHistoryTracking(true);
            this.value = '';
            return;
        }
        
        // Existing search logic with history tracking
        let isWebsite = false;
        
        // Check if it's a website search
        if (query.startsWith('http://') || query.startsWith('https://') || 
            query.includes('.com') || query.includes('.org') || query.includes('.net')) {
            isWebsite = true;
        }
        
        // Existing search prefixes that are typically websites
        const websitePrefixes = ['@y', '@mu', '@rbx', '@p', '@g', '@w'];
        if (websitePrefixes.some(prefix => query.startsWith(prefix))) {
            isWebsite = true;
        }
        
        // Add to history before processing the search
        if (query !== '') {
            addSearchToHistory(query, isWebsite);
        }        

        if (query === '@export') {
            exportLocalStorage();
            this.value = '';
            return;
        } 

        if (query === '@import') {
            importLocalStorage();
            this.value = '';
            return;
        }

        // New @important date handling with local storage
        if (query.toLowerCase().startsWith('@important')) {
            // Extract the date from the query
            const dateMatch = query.match(/^@important\s+(\d{2}\/\d{2}\/\d{4})(\s+(.+))?$/);
            
            if (dateMatch) {
                const [, dateStr, , description] = dateMatch;
                
                try {
                    // Validate date format
                    const [day, month, year] = dateStr.split('/').map(Number);
                    const inputDate = new Date(year, month - 1, day);
                    
                    // Validate date is in the future
                    const now = new Date();
                    if (inputDate <= now) {
                        alert("Please enter a future date.");
                        return;
                    }
                    
                    // Store the important date
                    importantDates.push({
                        date: inputDate,
                        description: description || 'Untitled Event'
                    });
                    
                    // Save to local storage
                    saveImportantDates();
                    
                    // Render all important dates
                    renderImportantDates();
                    
                    // Clear input
                    this.value = '';
                    platformPopup.style.display = 'none';
                } catch (error) {
                    alert("Invalid date format. Use DD/MM/YYYY");
                }
            } else {
                alert("Invalid @important format. Use @important DD/MM/YYYY [optional description]");
            }
        }
        window.addEventListener('load', renderImportantDates);
        setInterval(renderImportantDates, 60000); // Check every minute
// Function to calculate time left
function calculateTimeLeft(targetDate) {
    const now = new Date();
    const diffMs = targetDate.getTime() - now.getTime();
    
    if (diffMs <= 0) return null; // Date has passed
    
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    
    if (diffDays > 0) return `${diffDays}d`;
    if (diffHours > 0) return `${diffHours}h`;
    return `${diffMinutes}m`;
}

        // Block search if input is empty or only spaces
        if (query === '') {
            alert("Please enter a search term.");
            return; // Prevent search if input is empty or just spaces
        }

        if (query.toLowerCase().startsWith('@help')) {
        alert("Help is not a valid search query. Look at the popup for the commands");
        return; // Prevent search if @help is detected
        }        
        if (query.toLowerCase().startsWith('@important')) {
        return; // Prevent search if @help is detected
        }      

        if (query.toLowerCase() === '@24t') {
            timeFormat = '24';
            saveTimeFormat(); // Save to local storage
            updateDateTime();
            this.value = '';
            platformPopup.style.display = 'none';
            return;
        } 
        else if (query.toLowerCase() === '@12t') {
            timeFormat = '12';
            saveTimeFormat(); // Save to local storage
            updateDateTime();
            this.value = '';
            platformPopup.style.display = 'none';
            return;
        }

        // Toggle the display of the year with local storage
        if (query.toLowerCase() === '@year') {
            showYear = !showYear;
            saveYearPreference(); // Save to local storage
            updateDateTime();
            this.value = '';
            platformPopup.style.display = 'none';
            return;
        }


        // Ensure that only the exact match "@y" is valid, not "@ye"
        if (query.startsWith('@y') && (query.length === 2 || query[2] === ' ')) {
            query = query.slice(2).trim(); // Remove "@y" and trim the query
            window.location.href = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
        }
        // Ensure that only the exact match "@mu" is valid
        else if (query.startsWith('@mu') && (query.length === 3 || query[3] === ' ')) {
            query = query.slice(3).trim(); // Remove "@mu" and trim the query
            window.location.href = `https://music.youtube.com/search?q=${encodeURIComponent(query)}`;
        }
        // Ensure that only the exact match "@rbx" is valid
        else if (query.startsWith('@rbx') && (query.length === 4 || query[4] === ' ')) {
            query = query.slice(4).trim(); // Remove "@rbx" and trim the query
            window.location.href = `https://www.roblox.com/discover/?Keyword=${encodeURIComponent(query)}`;
        }
        // Ensure that only the exact match "@p" is valid
        else if (query.startsWith('@p') && (query.length === 2 || query[2] === ' ')) {
            query = query.slice(2).trim(); // Remove "@p" and trim the query
            window.location.href = `https://www.perplexity.ai/search?s=o&q=${encodeURIComponent(query)}`;
        } 
        else if (query.startsWith('@g') && (query.length === 2 || query[2] === ' ')) {
            query = query.slice(2).trim();
            window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        }
        else if (query.startsWith('@w') && (query.length === 2 || query[2] === ' ')) {
            query = query.slice(2).trim();
            window.location.href = `https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(query)}`;
        }
        // If the input is empty after the tag prefix, block the attempt and alert the user
        else if (query.toLowerCase().startsWith('@') && query.length <= 2) {
            alert("Please enter a valid search term after the tag.");
            return;
        }
        // If the input is a valid URL without the protocol, prepend "http://" automatically
        else if (!query.match(/^https?:\/\//)) {
            query = 'http://' + query; // Automatically add "http://" if not present
            if (isValidURL(query)) {
                window.location.href = query; // Navigate to the valid URL
            } else {
                window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`; // Perform Google search
            }
        } else if (isValidURL(query)) {
            // If it's a valid URL, navigate to it
            window.location.href = query;
        } else {
            // If it's not a URL, perform a Google search
            window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        }
    }
});


// Function to calculate time left
function calculateTimeLeft(targetDate) {
    const now = new Date();
    const diffMs = targetDate.getTime() - now.getTime();
    
    if (diffMs <= 0) return null; // Date has passed
    
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    
    if (diffDays > 0) return `${diffDays}d`;
    if (diffHours > 0) return `${diffHours}h`;
    return `${diffMinutes}m`;
}

// Function to format important date with optional year suppression
function formatImportantDate(date, suppressYearIfCurrentYear = true) {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    const dayName = days[date.getDay()];
    const monthName = months[date.getMonth()];
    const day = date.getDate();
    const year = date.getFullYear();
    const currentYear = new Date().getFullYear();
    
    // Determine ordinal suffix
    const ordinalSuffix = (day) => {
        if (day > 3 && day < 21) return 'th';
        switch (day % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
        }
    };
    
    // Conditionally include year based on current year and suppressYearIfCurrentYear flag
    const yearPart = (suppressYearIfCurrentYear && year === currentYear) ? '' : `, ${year}`;
    
    return `${monthName} ${day}${ordinalSuffix(day)}${yearPart}`;
}

// Function to render important dates
// Modify the existing renderImportantDates function
function renderImportantDates() {
    const importantDatesPopup = document.getElementById('importantDatesPopup');
    
    // Remove passed dates and track them separately
    const now = new Date();
    const passedEvents = [];
    importantDates = importantDates.filter(event => {
        if (event.date <= now) {
            // Store passed events
            passedEvents.push(event);
            return false;
        }
        return true;
    });
    
    // Save filtered dates to local storage
    saveImportantDates();
    
    // If no future dates, check for passed events
    if (importantDates.length === 0) {
        if (passedEvents.length > 0) {
            renderPassedEvents(passedEvents);
        } else {
            importantDatesPopup.style.display = 'none';
        }
        return;
    }
    
    // Sort future dates chronologically
    importantDates.sort((a, b) => a.date - b.date);
    
    // Create HTML for dates with editable features
    const datesHTML = importantDates.map((event, index) => {
        const timeLeft = calculateTimeLeft(event.date);
        
        return `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <span 
                onclick="editEventDate(${index})" 
                style="cursor: pointer;"
                title="Click to edit date"
            >${formatImportantDate(event.date)}</span>
            <span 
                onclick="editEventDescription(${index})" 
                style="cursor: pointer;"
                title="Click to edit description"
            >${event.description}</span>
            <span style="color: #00ff00;">${timeLeft || 'Passed'}</span>
            <button onclick="removeImportantDate(${index})" style="background: none; border: none; color: white; cursor: pointer;">‚ùå</button>
        </div>
    `}).join('');
    
    // Populate and show the popup
    importantDatesPopup.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 10px;">Important Dates:</div>
        ${datesHTML}
    `;
    importantDatesPopup.style.display = 'block';
}


// Function to render passed events
function renderPassedEvents(passedEvents) {
    const importantDatesPopup = document.getElementById('importantDatesPopup');
    
    // Create HTML for passed events
    const passedEventsHTML = passedEvents.map((event, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; color: #ff6347;">
            <span>Event "${event.description}" on ${formatImportantDate(event.date)} has occurred!</span>
            <button onclick="removePassedEvent(${index})" style="background: none; border: none; color: white; cursor: pointer;">‚ùå</button>
        </div>
    `).join('');
    
    // Populate and show the popup
    importantDatesPopup.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 10px; color: #ff6347;">Passed Events:</div>
        ${passedEventsHTML}
    `;
    importantDatesPopup.style.display = 'block';
    
    // Auto-remove passed events after 20 seconds
    setTimeout(() => {
        importantDatesPopup.style.display = 'none';
    }, 20000);
}

// Function to edit event date
function editEventDate(index) {
    const newDateStr = prompt('Enter new date (DD/MM/YYYY):', 
        formatDateForEditing(importantDates[index].date));
    
    if (newDateStr) {
        try {
            // Validate date format
            const [day, month, year] = newDateStr.split('/').map(Number);
            const inputDate = new Date(year, month - 1, day);
            
            // Validate date is in the future
            const now = new Date();
            if (inputDate <= now) {
                alert("Please enter a future date.");
                return;
            }
            
            // Update the date
            importantDates[index].date = inputDate;
            
            // Save and re-render
            saveImportantDates();
            renderImportantDates();
        } catch (error) {
            alert("Invalid date format. Use DD/MM/YYYY");
        }
    }
}

// Function to edit event description
function editEventDescription(index) {
    const newDescription = prompt('Enter new description:', 
        importantDates[index].description);
    
    if (newDescription !== null && newDescription.trim() !== '') {
        importantDates[index].description = newDescription.trim();
        
        // Save and re-render
        saveImportantDates();
        renderImportantDates();
    }
}

// Helper function to format date for editing
function formatDateForEditing(date) {
    return `${date.getDate().toString().padStart(2, '0')}/${
        (date.getMonth() + 1).toString().padStart(2, '0')}/${
        date.getFullYear()}`;
}

// Function to remove passed events
function removePassedEvent(index) {
    const importantDatesPopup = document.getElementById('importantDatesPopup');
    importantDatesPopup.style.display = 'none';
}

// Function to remove a specific important date
function removeImportantDate(index) {
    importantDates.splice(index, 1);
    saveImportantDates(); // Save to local storage after removal
    renderImportantDates();
}

// Clear the input field when the page is refreshed
window.addEventListener('load', function() {
    document.getElementById('searchInput').value = '';  // Clear input
    document.getElementById('clearBtn').style.display = 'none';  // Hide the 'X' button initially
    updateDateTime();  // Display time and date immediately upon load
    renderImportantDates(); // Load and render important dates from local storage
});

// Show/hide the 'X' button based on the input field content
const searchInput = document.getElementById('searchInput');
const clearBtn = document.getElementById('clearBtn');

searchInput.addEventListener('input', function() {
    if (this.value.trim() !== '') {
        clearBtn.style.display = 'block';
    } else {
        clearBtn.style.display = 'none';
    }
});

// Add functionality to clear the search input when the 'X' button is clicked
clearBtn.addEventListener('click', function() {
    searchInput.value = '';  // Clear the input field
    clearBtn.style.display = 'none';  // Hide the 'X' button
    const platformPopup = document.getElementById('platformPopup');
    platformPopup.style.display = 'none';
});

// Update the time display based on the selected format
function updateDateTime() {
    const now = new Date();
    const timeDisplay = document.getElementById('timeDisplay');
    const dateDisplay = document.getElementById('dateDisplay');

    // Time formatting based on 12-hour or 24-hour format
    let hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    let ampm = '';

    if (timeFormat === '12') {
        ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12; // Convert to 12-hour format
    }

    const timeString = timeFormat === '12' 
        ? `${hours} : ${minutes} : ${seconds} ${ampm}`
        : `${hours.toString().padStart(2, '0')} : ${minutes} : ${seconds}`; // 24-hour format

    // Date formatting
    const day = now.toLocaleString('en', { weekday: 'long' });
    const month = now.toLocaleString('en', { month: 'long' });
    const date = now.getDate();

    const ordinalSuffix = (date) => {
        if (date > 3 && date < 21) return 'th';
        switch (date % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
        }
    };

    // Conditionally include the year if `showYear` is true
    const year = showYear ? ` ${now.getFullYear()}` : '';
    dateDisplay.textContent = `${day}, ${month} ${date}${ordinalSuffix(date)}${year}`;
    timeDisplay.textContent = timeString;
}

setInterval(updateDateTime, 1000);  // Update every second

function exportLocalStorage() {
    const data = {
        importantDates: localStorage.getItem(LOCAL_STORAGE_IMPORTANT_DATES),
        timeFormat: localStorage.getItem(LOCAL_STORAGE_TIME_FORMAT),
        showYearPreference: localStorage.getItem(LOCAL_STORAGE_SHOW_YEAR)
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = 'localStorageBackup.json';
    link.click();

    URL.revokeObjectURL(url);
}

function importLocalStorage() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';

    input.addEventListener('change', function () {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Update local storage
                    if (importedData.importantDates) {
                        localStorage.setItem(LOCAL_STORAGE_IMPORTANT_DATES, importedData.importantDates);
                    }
                    if (importedData.timeFormat) {
                        localStorage.setItem(LOCAL_STORAGE_TIME_FORMAT, importedData.timeFormat);
                    }
                    if (importedData.showYearPreference) {
                        localStorage.setItem(LOCAL_STORAGE_SHOW_YEAR, importedData.showYearPreference);
                    }

                    alert('Import successful. Refreshing...');
                    location.reload();
                } catch (error) {
                    alert('Invalid JSON file. Please try again.');
                }
            };
            reader.readAsText(file);
        }
    });

    input.click();
}


    </script>
</body>
</html>
